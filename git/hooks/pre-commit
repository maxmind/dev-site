#!/bin/bash

set -eu

function timed_run() {
    description=$1
    command=$2
    timer=$(date +%s)

    $command
    exit_code=$?
    timer=$(($(date +%s) - timer))

    verbose=${MM_VERBOSE_HOOKS:-0}

    if [ "$verbose" == "1" ]; then
        echo "ℹ️  $description - $timer seconds"
        echo "exit code: $exit_code"
    fi

    if [ $exit_code -ne 0 ]; then
        echo "ℹ️  $description - failed"
        exit $exit_code
    fi
}

# Regenerate static/_headers from _headers.config.ts if it changed
if git diff --cached --name-only | grep -q "scripts/_headers.config.ts"; then
  echo "Detected changes to scripts/_headers.config.ts, regenerating static/_headers..."
  npx tsx scripts/generate-headers.ts
  git add static/_headers
  echo "✅ Updated static/_headers and added to commit"
fi

# Also regenerate if the generator script itself changed
if git diff --cached --name-only | grep -q "scripts/generate-headers.ts"; then
  echo "Detected changes to generator script, regenerating static/_headers..."
  npx tsx scripts/generate-headers.ts
  git add static/_headers
  echo "✅ Updated static/_headers and added to commit"
fi

timed_run "precious lint" "precious lint --staged"
