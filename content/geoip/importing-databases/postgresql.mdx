---
draft: true
title: Importing GeoIP2 and GeoLite2 databases to PostgreSQL
---

This guide will show you how to import GeoIP2 or GeoLite2 databases into
PostgreSQL so that they can be easily queried and manipulated on your server.

## Retrieve database

Link readers to where they can purchase and download the zip file.

Tell them to unpack the archive and link to 
https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/#Zip_File
for details of zip structure.

## Networks

### Schema

First we create a table to hold the network information contained in
`GeoIP2-City-Blocks-IPv4.csv` and `GeoIP2-City-Blocks-IPv6.csv`.
https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/#CSV_File_Format
describes the structure of those files.

```sql
create table geoip2_network (
  network cidr not null,
  geoname_id int,
  registered_country_geoname_id int,
  represented_country_geoname_id int,
  is_anonymous_proxy bool,
  is_satellite_provider bool,
  postal_code text,
  latitude numeric,
  longitude numeric,
  accuracy_radius int
);
```

### Load Data

With the table created, we can now import the contents of the two `Blocks` files:

```sql
\copy geoip2_network(
  network, geoname_id, registered_country_geoname_id, represented_country_geoname_id,
  is_anonymous_proxy, is_satellite_provider, postal_code, latitude, longitude, accuracy_radius
) from 'GeoIP2-City-Blocks-IPv4.csv' with (format csv, header);
```

```sql
\copy geoip2_network(
  network, geoname_id, registered_country_geoname_id, represented_country_geoname_id,
  is_anonymous_proxy, is_satellite_provider, postal_code, latitude, longitude, accuracy_radius
) from 'GeoIP2-City-Blocks-IPv6.csv' with (format csv, header);
```

### Query

Note how the table we created uses PostgreSQL's
[cidr](https://www.postgresql.org/docs/current/datatype-net-types.html) type
for the network column. This built-in type represents IPv4 and IPv6 networks and
provides [operations](https://www.postgresql.org/docs/current/functions-net.html)
to, amoung other things, determine if a given host address is contained in a
network. For example:

```sql
select '192.168.0.0/24'::cidr >> '192.168.0.1'; -- true
select '192.168.0.0/24'::cidr >> '192.168.1.1'; -- false
```

We can use that to look up the `geoip2_network` entry for a given IP address
like so:

TODO: use a different address and update output accordingly

```sql
select * from geoip2_network where network >> '97.115.100.128';
```

```
-[ RECORD 1 ]------------------+------------------
network                        | 97.115.100.128/25
geoname_id                     | 5746545
registered_country_geoname_id  | 6252001
represented_country_geoname_id | 
is_anonymous_proxy             | f
is_satellite_provider          | f
postal_code                    | 97206
latitude                       | 45.4804
longitude                      | -122.5891
accuracy_radius                | 10

Time: 514.003 ms
```

### Index

While that allows us to look up an individual IP address's latitude, longitude,
and accuracy_radius, you'll notice that executing that query took over half a
second which isn't practical for many applications. To improve that we'll create
an index using PostgreSQL's
[GiST](https://www.postgresql.org/docs/current/textsearch-indexes.html) indexing
method. For historical reasons, we also have to specify the
[inet_ops](https://www.postgresql.org/docs/9.5/gist-builtin-opclasses.html)
operator class:

```sql
create index on geoip2_network using gist (network inet_ops);
```

With that change we observe the same query from before now being a lot faster:

```sql
select * from geoip2_network net where network >> '97.115.100.128';
```

```
-[ RECORD 1 ]------------------+------------------
network                        | 97.115.100.128/25
geoname_id                     | 5746545
registered_country_geoname_id  | 6252001
represented_country_geoname_id | 
is_anonymous_proxy             | f
is_satellite_provider          | f
postal_code                    | 97206
latitude                       | 45.4804
longitude                      | -122.5891
accuracy_radius                | 10

Time: 9.671 ms
```

## Locations

If `postal_code`, `latitude`, `longitude`, and `accuracy_radius` are everything
we're interested in we'd be done at this point and our application would be
easily able to query what it needs. However, GeoIP2 databases provide additional
location information, which we'll load into PostgreSQL next.

### Import

We start with a table as before:

```sql
create table geoip2_location (
  geoname_id int not null,
  locale_code text not null,
  continent_code text not null,
  continent_name text not null,
  country_iso_code text,
  country_name text,
  subdivision_1_iso_code text,
  subdivision_1_name text,
  subdivision_2_iso_code text,
  subdivision_2_name text,
  city_name text,
  metro_code int,
  time_zone text,
  is_in_european_union bool not null,
  primary key (geoname_id, locale_code)
);
```

We then populate that table from a `Locations` CSV file:

```sql
\copy geoip2_location(
  geoname_id, locale_code, continent_code, continent_name, country_iso_code, country_name,
  subdivision_1_iso_code, subdivision_1_name, subdivision_2_iso_code, subdivision_2_name,
  city_name, metro_code, time_zone, is_in_european_union
) from 'GeoIP2-City-Locations-en.csv' with (format csv, header);
```

Note that there's a number of different `Locations` files available. The `-en`
file contains english language data for all `geoname_id`s used in the the
database. The additional files with different language suffixes contain
localized versions of the `-en` data in different languages for some of
`geoname_id`s. Depending on your application's needs you may decide to import
any subset of them.

### Querying

We can now use this additional table to resolve the `geoname_id`s provided by
our `geoip2_network` table. For example:

```sql
select latitude, longitude, accuracy_radius, continent_name, country_name, subdivision_1_name, city_name
from geoip2_network net
left join geoip2_location location on (
  net.geoname_id = location.geoname_id
  and location.locale_code = 'en'
)
where network >> '97.115.100.128';
```

```
 latitude | longitude | accuracy_radius | continent_name | country_name  | subdivision_1_name | city_name 
----------+-----------+-----------------+----------------+---------------+--------------------+-----------
  45.4804 | -122.5891 |              10 | North America  | United States | Oregon             | Portland
(1 row)
```

Here we were only interested in english results, but we can adjust our join
condition if we were interested in different or additional languages.

Note how a left outer join is used. This is because additional location
information might not be available for any given row of our `geoip2_network`
table. With the left join we'd still receive latitude, longitude, and
accuracy_radius as a result of our query if available, while an inner join
would result in zero rows if no additional location information was available.

In addition to the `geoname_id` column that provides location information for a
network, there's also `registered_country_geoname_id` and
`represented_country_geoname_id`, which provide location information about the
country in which the ISP has registered the network, and the country which is
represented by users of the IP address, respectively. The location data for both
can be included by additional joins:

```sql
select latitude, longitude, accuracy_radius,
       location.continent_name as location_continent_name,
       location.country_name as location_country_name,
       location.subdivision_1_name as location_subdivision_1_name,
       location.city_name as location_city_name,
       registered_country.continent_name as registered_country_continent_name,
       registered_country.country_name as registered_country_country_name,
       represented_country.continent_name as represented_country_continent_name,
       represented_country.country_name as represented_country_country_name
from geoip2_network net
left join geoip2_location location on (
  net.geoname_id = location.geoname_id
  and location.locale_code = 'en'
)
left join geoip2_location registered_country on (
  net.registered_country_geoname_id = registered_country.geoname_id
  and registered_country.locale_code = 'en'
)
left join geoip2_location represented_country on (
  net.represented_country_geoname_id = represented_country.geoname_id
  and represented_country.locale_code = 'en'
)
where network >> '97.115.100.128';
```

```
-[ RECORD 1 ]----------------------+--------------
latitude                           | 45.4804
longitude                          | -122.5891
accuracy_radius                    | 10
location_continent_name            | North America
location_country_name              | United States
location_subdivision_1_name        | Oregon
location_city_name                 | Portland
registered_country_continent_name  | North America
registered_country_country_name    | United States
represented_country_continent_name | 
represented_country_country_name   | 
```

## Summary